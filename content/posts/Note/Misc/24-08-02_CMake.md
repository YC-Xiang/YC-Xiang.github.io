---
title: Cmake Reference
date: 2024-11-13 21:32:28
tags:
  - Tool
categories:
  - Notes
---

# Reference

https://cmake.org/cmake/help/latest/

# cmake

## Introduction to CMake Buildsystems

To generate a buildsystem with CMake, the following must be selected:

Source Tree:

源文件目录，包含 top-level 的 CMakeLists.txt。

Build Tree:

编译输出文件，包含 CMakeCache.txt。

Generator:

选择 buildsystem 的 generator，比如 make, ninja 等，利用-G 选项来选择。

## Generate a Project Buildsystem

以下几种命令用来指定 source 和 build tree，生成 buildsystem：

`cmake [<options>] -B <path-to-build> [-S <path-to-source>]`

-S 选择顶层 CMakeLists.txt 所在目录。

-B 选择编译输出目录，如果不存在会自动创建。

```cmake
cmake -S src -B build
```

</br>

`cmake [<options>] <path-to-source>`

如果不指定-B 编译目录，那么默认当前目录为编译目录。需要指定 path-to-source 即顶层 CMakeLists.txt 所在目录，注意这两个目录不能为同一个目录。

```cmake
mkdir build ; cd build
cmake ../src
```

</br>

`cmake [<options>] <path-to-existing-build>`

如果已经编译过了，那么可以在 build 目录下执行 cmake，会自动从 CMakeCache.txt 中加载 source tree 的路径。

```cmake
cd build
cmake .
```

</br>

有多种组合，如下图：

If only one type of path is given, the current working directory (cwd) is used for the other.

![](https://xyc-1316422823.cos.ap-shanghai.myqcloud.com/20241113230053.png)

## Options

前面命令中的`<options>`选项有:

`-S <path-to-source>`

CMakeLists.txt 入口

`-B <path-to-build>`

编译目录, 如果不存在会自动创建

`-C <initial-cache>`

预加载 script, 用来设置一些 cache 变量

`-D <var>=<value> -D <var>:<type>=<value>`

设置 cache 变量.

如果-C 的脚本文件中设置变量加了 FORCE, 那么变量值和-C -D 选项顺序有关系, 如果有相同的变量, 那么后面的会覆盖前面的.

如果-C 的脚本文件中设置变量没加 FORCE, 那么-D 设置的变量一定会覆盖-C 设置的, 和顺序无关.

```cmake
set(CMAKE_BUILD_TYPE "Release" CACHE STRING "" FORCE)
```

`-U <globbing_expr>`

从 CmakeCache.txt 中删除条目, 可以使用\*和?来匹配.

`-G <generator-name>`

build system generator, 比如 make, ninja.

也可通过设置 CMake 变量 CMAKE_GENERATOR.

`--toolchain <path-to-file>`

设置交叉编译工具链文件, 等同于设置变量 CMAKE_TOOLCHAIN_FILE.

相对路径是以 build 目录为基准, 如果没找到, 那么以 source 目录为基准.

`--install-prefix <directory>`

设置 make install 的目录, 默认为/usr/local, 必须是绝对路径.

# cmake-buildsystem

cmake 中 target 包括 executable or library.

可执行文件和静态库通过 add_executable 和 add_library 创建.

```cmake
add_library(archive archive.cpp zip.cpp lzma.cpp)
add_executable(zipapp zipapp.cpp)
target_link_libraries(zipapp archive)
```

</br>

add_library 默认创建静态库, 除非指定 type.

```cmake
add_library(archive SHARED archive.cpp zip.cpp lzma.cpp) # 动态库
add_library(archive STATIC archive.cpp zip.cpp lzma.cpp) # 静态库
```

</br>

object library 是一组目标文件的集合,可以用来当做 input,
通过`$<TARGET_OBJECTS:name>`传给其他 target.

```cmake
add_library(archive OBJECT archive.cpp zip.cpp lzma.cpp)
add_library(archiveExtras STATIC $<TARGET_OBJECTS:archive> extras.cpp)
add_executable(test_exe $<TARGET_OBJECTS:archive> test.cpp)
```

也可以直接链接到 target:

```cmake
add_library(archive OBJECT archive.cpp zip.cpp lzma.cpp)

add_library(archiveExtras STATIC extras.cpp)
target_link_libraries(archiveExtras PUBLIC archive)

add_executable(test_exe test.cpp)
target_link_libraries(test_exe archive)
```

## Target Commands

`target_compile_definitions()`

`target_compile_options()`

`target_compile_features()`

`target_include_directories()`

`target_sources()`

`target_precompile_headers()`

`target_link_libraries()`

`target_link_directories()`

`target_link_options()`
