---
date: 2025-06-19T15:15:29+08:00
title: "V4L2 -- File Handler"
tags:
  - V4L2
categories:
  - V4L2
---

## 2.6 V4L2 File handlers

struct v4l2_fh 保存了 file handle 的 specific data.

struct v4l2_fh 在 driver 的 .open() 函数中分配。通常嵌入在 driver private struct 中。v4l2_fh 通过 `v4l2_fh_init()` 初始化，通过`v4l2_fh_add` 加入到 video device 中。

在 userspace open device node 后，调用到 v4l2_fh_open, 会把 file->private_data 设置为 fh.

v4l2_fh 在 .release() 中释放。通过`v4l2_fh_del()` 从 video device 中 remove 和`v4l2_fh_exit()` 来 cleanup.

driver 不能直接访问 file->private_data, 需要通过`file_to_v4l2_fh()`来获取 v4l2_fh. 再通过 container_of() 宏获取 driver private data.

```c++
struct v4l2_fh {
	struct list_head	list;
	struct video_device	*vdev;
	struct v4l2_ctrl_handler *ctrl_handler;
	enum v4l2_priority	prio;

	wait_queue_head_t	wait;
	struct mutex		subscribe_lock;
	struct list_head	subscribed;
	struct list_head	available;
	unsigned int		navailable;
	u32			sequence;

	struct v4l2_m2m_ctx	*m2m_ctx;
};
```

list: 链接到 video_device 的 fh_list.  
vdev: 指向 video_device.  
ctrl_handler: 指向 video_device 的 ctrl_handler.  
prio: file handler 的优先级。
wait: 进程等待队列。
subscribe_lock: 串行化 subscribe list.  
subscribed: subscribe list, 保存该文件订阅的 event 类型，挂载 struct v4l2_subscribed_event->list.  
available: 存储待处理的 event list, 挂载 struct v4l2_kevent->list.  
navailable: 待处理事件的数量。
sequence: 给每个 event 分配的序列号。
m2m_ctx:

流程：

应用程序通过 VIDIOC_SUBSCRIBE_EVENT ioctl 订阅感兴趣的 events.
驱动程序将事件类型添加到 subscribed list.
当事件发生时，驱动将事件添加到 available list.
应用程序通过 VIDIOC_DQEVENT ioctl 获取事件。
如果没有可用事件，进程会在 wait 队列上等待。
